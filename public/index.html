<!DOCTYPE html>
<html>

<head>
  <title>bullish</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@30.0.3/dist/ag-grid-enterprise.min.js"></script>
</head>

<body>
  <h1 id="msg">Stock list bullish</h1>
  <button onclick="fetchData()">Refresh</button>
  <button onclick="onBtExport()">Export</button>
  <div id="myGrid" style="height: 650px;" class="ag-theme-alpine"></div>
  <script>
    const socket = io();
    const msgHTML = document.getElementById("msg");

    const columnDefs = [
      { field: "name"},
      { field: "mcap", filter: 'agNumberColumnFilter' },
      { field: "isBearish", filter: 'agSetColumnFilter' },
      { field: "isBullish", filter: 'agSetColumnFilter' },
      { field: "symbol", filter: 'agNumberColumnFilter', hide: true, },
      { field: "price", filter: 'agNumberColumnFilter', hide: true, },
      { field: "rsi", filter: 'agNumberColumnFilter', hide: true, },
      { field: "DMA_20", filter: 'agNumberColumnFilter', hide: true, },
      { field: "DMA_50", filter: 'agNumberColumnFilter', hide: true, },
      { field: "DMA_100", filter: 'agNumberColumnFilter', hide: true, },
      { field: "DMA_200", filter: 'agNumberColumnFilter', hide: true, },
      { field: "url", hide: true, },
    ];

    function onSelectionChanged() {
      const selectedRows = gridOptions.api.getSelectedRows();
      const url = selectedRows.length === 1 ? selectedRows[0].url : '';
      console.log(url);
      if (url) {
        window.open(url)
      }
    }

    function fetchData() {
      socket.emit('message', '');
    }

    let rowData = [];
    let buffer = [];
    let buffer_size = 10;

    const gridOptions = {
      columnDefs: columnDefs,
      rowData: rowData,
      defaultColDef: {
        flex: 1,
        minWidth: 150,
        filter: 'agTextColumnFilter',
        menuTabs: ['filterMenuTab'],
        sortable : true,
        enableValue: true,
        enableRowGroup: true,
        enablePivot: true,
      },
      autoGroupColumnDef: {
        minWidth: 200,
      },
      sideBar: {
            toolPanels: [
                {
                    id: "columns",
                    labelDefault: "Columns",
                    labelKey: "columns",
                    iconKey: "columns",
                    toolPanel: "agColumnsToolPanel",
                },
                {
                    id: "filters",
                    labelDefault: "Filters",
                    labelKey: "filters",
                    iconKey: "filter",
                    toolPanel: "agFiltersToolPanel",
                },
            ],
            defaultToolPanel: "",
      },
      enableRangeSelection: true,
      rowSelection: 'single',
      onSelectionChanged: onSelectionChanged,
    };

    function onBtExport() {
      gridOptions.api.exportDataAsExcel();
    }

    // Handle receiving messages
    socket.on('message', (data) => {
      if (data.length !== undefined) {
        rowData = data
        gridOptions.api.setRowData(rowData);
      } else {
        if (data['isBullish'] || data['isBearish'] ) {
          buffer.push(data)
          if (buffer.length > buffer) {
            rowData.concat(buffer);
            buffer = [];
            gridOptions.api.setRowData(rowData);
          }
        }
        msgHTML.innerHTML = data['msg'];
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const gridDiv = document.querySelector('#myGrid');
      new agGrid.Grid(gridDiv, gridOptions);
    });

  </script>
</body>

</html>
